ALTER TYPE target_type ADD VALUE IF NOT EXISTS 'طالب';

-- Step 1: Add the student_id column
ALTER TABLE public.logs 
ADD COLUMN student_id integer;

-- Step 2: Add the foreign key constraint
ALTER TABLE public.logs
ADD CONSTRAINT logs_student_fk FOREIGN KEY (student_id)
    REFERENCES public.students (student_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;

-- Step 3: Drop the old check constraint
ALTER TABLE public.logs
DROP CONSTRAINT logs_single_target_check;

-- Step 4: Add the new check constraint with student logic
ALTER TABLE public.logs
ADD CONSTRAINT logs_single_target_check CHECK (
    -- Original: Event target
    (target_type = 'نشاط'::target_type AND event_id IS NOT NULL AND solidarity_id IS NULL AND family_id IS NULL AND student_id IS NULL)
    OR
    -- Original: Solidarity target
    (target_type = 'تكافل'::target_type AND solidarity_id IS NOT NULL AND event_id IS NULL AND family_id IS NULL AND student_id IS NULL)
    OR
    -- Original: Family target
    (target_type = 'اسر'::target_type AND family_id IS NOT NULL AND event_id IS NULL AND solidarity_id IS NULL AND student_id IS NULL)
    OR
    -- NEW: Student target (family_id can be NULL or NOT NULL)
    (target_type = 'طالب'::target_type AND student_id IS NOT NULL AND event_id IS NULL AND solidarity_id IS NULL)
);

-- Step 5: Add index for student_id
CREATE INDEX IF NOT EXISTS idx_logs_student_id
    ON public.logs USING btree
    (student_id ASC NULLS LAST)
    WITH (fillfactor=100, deduplicate_items=True)
    TABLESPACE pg_default;